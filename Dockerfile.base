FROM oven/bun:1 AS base

# Install Node.js to get npm (needed for pnpm installation)
RUN apt-get update && apt-get install -y \
    curl \
    && curl -fsSL https://deb.nodesource.com/setup_22.x | bash - \
    && apt-get install -y nodejs \
    && rm -rf /var/lib/apt/lists/*

# Install pnpm for package management (catalog protocol support)
RUN npm install -g pnpm

# Install system dependencies and Python
RUN apt-get update && apt-get install -y \
    python3 \
    python3-pip \
    python3-venv \
    python3-full \
    pipx \
    && rm -rf /var/lib/apt/lists/*

# Install uvx using pipx for root user
RUN pipx install uv

# Make uvx available system-wide with proper permissions
RUN cp /root/.local/bin/uv /usr/local/bin/uv && chmod 755 /usr/local/bin/uv
RUN cp /root/.local/bin/uvx /usr/local/bin/uvx && chmod 755 /usr/local/bin/uvx

# Also create uvx wrapper for uaip user
RUN echo '#!/bin/bash\nexec /usr/local/bin/uvx "$@"' > /usr/local/bin/uvx-uaip && chmod 755 /usr/local/bin/uvx-uaip

# Also install for the uaip user when we switch
RUN mkdir -p /home/uaip/.local/bin

# Install common MCP servers globally
RUN /usr/local/bin/uvx --python python3 -c "import sys; print('Python available')" || echo "Python check failed"

# Set working directory and create user
WORKDIR /app
RUN addgroup --gid 1001 nodejs && \
    adduser --uid 1001 --ingroup nodejs --disabled-login uaip

# Copy workspace configuration
COPY pnpm-workspace.yaml ./
COPY package.json ./
COPY pnpm-lock.yaml ./
COPY tsconfig.json ./

# Copy all packages and backend code
COPY packages/ ./packages/
COPY backend/ ./backend/

# Fix home directory ownership and change ownership
RUN chown -R uaip:nodejs /home/uaip /app

# Switch to uaip user and set up environment
USER uaip

# Set up PATH for uaip user to include uvx
ENV PATH="/usr/local/bin:/root/.local/bin:${PATH}"

# Install all dependencies using pnpm (catalog protocol support)
RUN pnpm install

# Build shared packages once
RUN pnpm build:shared
RUN cd backend && pnpm build-shared

# Create entrypoint script
USER root
COPY <<'EOF' /app/entrypoint-dev.sh
#!/bin/sh

# Default values
SERVICE_NAME=${SERVICE_NAME:-orchestration-pipeline}
SERVICE_PORT=${SERVICE_PORT:-3002}

# Check MCP tools availability
echo "Checking MCP tools availability..."
echo "uvx version: $(uvx --version 2>/dev/null || echo 'not available')"
echo "bun version: $(bun --version 2>/dev/null || echo 'not available')"
echo "pnpm version: $(pnpm --version 2>/dev/null || echo 'not available')"
echo "python3 version: $(python3 --version 2>/dev/null || echo 'not available')"

# Validate service name
case "$SERVICE_NAME" in
  "artifact-service"|"orchestration-pipeline"|"security-gateway"|"capability-registry"|"agent-intelligence"|"discussion-orchestration"|"llm-service")
    echo "Starting development service: $SERVICE_NAME on port: $SERVICE_PORT with hot reloading"
    ;;
  *)
    echo "Error: Invalid SERVICE_NAME. Must be one of: orchestration-pipeline, security-gateway, capability-registry, agent-intelligence, discussion-orchestration, artifact-service, llm-service"
    exit 1
    ;;
esac

# Change to service directory
cd "/app/backend/services/$SERVICE_NAME"

# Check if src directory exists
if [ ! -d "src" ]; then
  echo "Error: src directory not found for service $SERVICE_NAME"
  echo "Available files in service directory:"
  ls -la .
  echo "Available services:"
  ls -la /app/backend/services/
  exit 1
fi

# Check if main entry file exists
if [ ! -f "src/index.ts" ]; then
  echo "Error: src/index.ts not found for service $SERVICE_NAME"
  echo "Available files in src directory:"
  ls -la src/
  exit 1
fi

echo "Starting $SERVICE_NAME with Bun..."
echo "Entry point: src/index.ts"

# Shared packages are already built in base image
echo "Using pre-built shared packages"

# Start the service with bun (direct execution, no auto-serve)
exec bun src/index.ts
EOF

RUN chmod +x /app/entrypoint-dev.sh

# Switch back to uaip user for runtime
USER uaip

# Expose ports
EXPOSE 3001 3002 3003 3004 3005 3006 3007

# Health check script
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
  CMD curl -f http://localhost:${SERVICE_PORT:-3002}/health || exit 1

ENTRYPOINT ["/app/entrypoint-dev.sh"]
