# =============================================================================
# Navratna - Optimized Base Docker Image (Bun + pnpm)
# =============================================================================
# Optimizations:
# - Multi-stage build for smaller final image
# - Layer caching for dependencies (changes less often than code)
# - BuildKit cache mounts for pnpm store
# - Parallel package installation
# - Minimal apt-get layers
# =============================================================================

# -----------------------------------------------------------------------------
# Stage 1: Base with system dependencies (cached, rarely changes)
# -----------------------------------------------------------------------------
FROM oven/bun:1 AS system-base

# Install all system deps in single layer
RUN apt-get update && apt-get install -y --no-install-recommends \
    curl \
    ca-certificates \
    python3 \
    python3-pip \
    python3-venv \
    pipx \
    && rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

# Install pnpm standalone + uv/uvx
ENV PNPM_HOME="/usr/local/share/pnpm"
ENV PATH="${PNPM_HOME}:${PATH}"
RUN curl -fsSL https://get.pnpm.io/install.sh | ENV="${PNPM_HOME}" SHELL="$(which bash)" bash - \
    && pipx install uv \
    && cp /root/.local/bin/uv /usr/local/bin/uv \
    && cp /root/.local/bin/uvx /usr/local/bin/uvx \
    && chmod 755 /usr/local/bin/uv /usr/local/bin/uvx

# -----------------------------------------------------------------------------
# Stage 2: Dependencies (cached separately from source code)
# -----------------------------------------------------------------------------
FROM system-base AS deps

WORKDIR /app

# Copy ONLY dependency files first (better cache hit rate)
COPY pnpm-workspace.yaml package.json pnpm-lock.yaml ./
COPY packages/shared-types/package.json ./packages/shared-types/
COPY packages/shared-utils/package.json ./packages/shared-utils/
COPY backend/package.json ./backend/
COPY backend/shared/services/package.json ./backend/shared/services/
COPY backend/shared/middleware/package.json ./backend/shared/middleware/
COPY backend/shared/config/package.json ./backend/shared/config/
COPY backend/shared/llm-service/package.json ./backend/shared/llm-service/
COPY backend/services/agent-intelligence/package.json ./backend/services/agent-intelligence/
COPY backend/services/orchestration-pipeline/package.json ./backend/services/orchestration-pipeline/
COPY backend/services/capability-registry/package.json ./backend/services/capability-registry/
COPY backend/services/security-gateway/package.json ./backend/services/security-gateway/
COPY backend/services/discussion-orchestration/package.json ./backend/services/discussion-orchestration/
COPY backend/services/artifact-service/package.json ./backend/services/artifact-service/
COPY backend/services/llm-service/package.json ./backend/services/llm-service/

# Install deps with cache mount (HUGE speed boost on rebuilds)
RUN --mount=type=cache,id=pnpm,target=/usr/local/share/pnpm/store \
    pnpm install --frozen-lockfile

# -----------------------------------------------------------------------------
# Stage 3: Build shared packages
# -----------------------------------------------------------------------------
FROM deps AS builder

# Copy tsconfig for builds
COPY tsconfig.json ./

# Copy source code
COPY packages/ ./packages/
COPY backend/ ./backend/

# Build shared packages
RUN pnpm build:shared && cd backend && pnpm build-shared

# -----------------------------------------------------------------------------
# Stage 4: Development image (hot reload ready)
# -----------------------------------------------------------------------------
FROM system-base AS development

WORKDIR /app

# Create non-root user (Debian uses groupadd/useradd)
RUN groupadd --gid 1001 bunjs \
    && useradd --uid 1001 --gid bunjs --create-home --home-dir /home/uaip uaip \
    && mkdir -p /home/uaip/.local/bin \
    && chown -R uaip:bunjs /home/uaip

# Copy installed deps and built packages from builder
COPY --from=builder --chown=uaip:bunjs /app/node_modules ./node_modules
COPY --from=builder --chown=uaip:bunjs /app/packages ./packages
COPY --from=builder --chown=uaip:bunjs /app/backend ./backend
COPY --from=builder --chown=uaip:bunjs /app/pnpm-workspace.yaml /app/package.json /app/pnpm-lock.yaml /app/tsconfig.json ./

ENV PNPM_HOME="/usr/local/share/pnpm"
ENV PATH="${PNPM_HOME}:/usr/local/bin:${PATH}"

# Entrypoint script (inline to avoid extra COPY)
RUN cat > /app/entrypoint-dev.sh << 'ENTRYPOINT'
#!/bin/sh
set -e

SERVICE_NAME=${SERVICE_NAME:-orchestration-pipeline}
SERVICE_PORT=${SERVICE_PORT:-3002}

case "$SERVICE_NAME" in
  artifact-service|orchestration-pipeline|security-gateway|capability-registry|agent-intelligence|discussion-orchestration|llm-service)
    echo "Starting $SERVICE_NAME on port $SERVICE_PORT"
    ;;
  *)
    echo "Error: Invalid SERVICE_NAME: $SERVICE_NAME"
    exit 1
    ;;
esac

cd "/app/backend/services/$SERVICE_NAME"
exec bun --hot src/index.ts
ENTRYPOINT
RUN chmod +x /app/entrypoint-dev.sh

USER uaip
EXPOSE 3001 3002 3003 3004 3005 3006 3007

HEALTHCHECK --interval=30s --timeout=5s --start-period=30s --retries=3 \
  CMD bun -e "fetch('http://localhost:${SERVICE_PORT:-3002}/health').then(r=>process.exit(r.ok?0:1)).catch(()=>process.exit(1))"

ENTRYPOINT ["/app/entrypoint-dev.sh"]
